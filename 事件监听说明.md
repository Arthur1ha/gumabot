# äº‹ä»¶ç›‘å¬ï¼ˆEvent Listeningï¼‰è¯¦è§£

## ğŸ“š ä»€ä¹ˆæ˜¯äº‹ä»¶ç›‘å¬ï¼Ÿ

### ç”Ÿæ´»ä¸­çš„ä¾‹å­

æƒ³è±¡ä¸€ä¸‹æ—¥å¸¸ç”Ÿæ´»ä¸­çš„åœºæ™¯ï¼š

1. **é—¨é“ƒå“äº†** â†’ ä½ å»å¼€é—¨
2. **æ‰‹æœºæ”¶åˆ°æ¶ˆæ¯** â†’ ä½ æŸ¥çœ‹é€šçŸ¥
3. **é—¹é’Ÿå“äº†** â†’ ä½ èµ·åºŠ

è¿™äº›éƒ½æ˜¯"äº‹ä»¶"å’Œ"å“åº”"çš„å…³ç³»ï¼š
- **äº‹ä»¶**ï¼šé—¨é“ƒå“ã€æ”¶åˆ°æ¶ˆæ¯ã€é—¹é’Ÿå“
- **å“åº”**ï¼šå¼€é—¨ã€æŸ¥çœ‹é€šçŸ¥ã€èµ·åºŠ

### åœ¨ç¼–ç¨‹ä¸­çš„æ¦‚å¿µ

åœ¨ä»£ç ä¸­ï¼Œäº‹ä»¶ç›‘å¬çš„å·¥ä½œåŸç†æ˜¯ä¸€æ ·çš„ï¼š

```python
# ä¼ªä»£ç ç¤ºä¾‹
å½“ "ç”¨æˆ·è¯´è¯" è¿™ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶:
    æ‰§è¡Œ "è®°å½•ç”¨æˆ·è¯´çš„è¯" è¿™ä¸ªå‡½æ•°
```

## ğŸ” åœ¨ LiveKit ä¸­çš„äº‹ä»¶

LiveKit ä¼šåœ¨å¯¹è¯è¿‡ç¨‹ä¸­è§¦å‘å„ç§äº‹ä»¶ï¼š

| äº‹ä»¶åç§° | ä»€ä¹ˆæ—¶å€™è§¦å‘ | åŒ…å«ä»€ä¹ˆä¿¡æ¯ |
|---------|------------|------------|
| `user_transcript` | ç”¨æˆ·è¯´è¯æ—¶ | ç”¨æˆ·è¯´çš„è¯ï¼ˆæ–‡æœ¬ï¼‰ |
| `agent_transcript` | åŠ©æ‰‹å›å¤æ—¶ | åŠ©æ‰‹è¯´çš„è¯ï¼ˆæ–‡æœ¬ï¼‰ |
| `turn_finished` | ä¸€è½®å®Œæ•´å¯¹è¯ç»“æŸæ—¶ | ç”¨æˆ·å’ŒåŠ©æ‰‹çš„å®Œæ•´å¯¹è¯ |

## ğŸ’» ä»£ç ç¤ºä¾‹è§£æ

### åŸºæœ¬è¯­æ³•

```python
@session.on("äº‹ä»¶åç§°")
def å¤„ç†å‡½æ•°(äº‹ä»¶æ•°æ®):
    # å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨
    print("äº‹ä»¶å‘ç”Ÿäº†ï¼")
```

### å®é™…ä¾‹å­

```python
# 1. ç›‘å¬ç”¨æˆ·è¯´è¯
@session.on("user_transcript")
def on_user_speaks(transcript):
    """
    å½“ç”¨æˆ·è¯´è¯æ—¶ï¼ŒLiveKit ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°
    transcript å‚æ•°åŒ…å«äº†ç”¨æˆ·è¯´çš„è¯
    """
    user_text = transcript.text  # è·å–ç”¨æˆ·è¯´çš„è¯
    print(f"ç”¨æˆ·è¯´: {user_text}")

# 2. ç›‘å¬åŠ©æ‰‹å›å¤
@session.on("agent_transcript")
def on_agent_speaks(transcript):
    """
    å½“åŠ©æ‰‹å›å¤æ—¶ï¼ŒLiveKit ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°
    transcript å‚æ•°åŒ…å«äº†åŠ©æ‰‹è¯´çš„è¯
    """
    agent_text = transcript.text  # è·å–åŠ©æ‰‹è¯´çš„è¯
    print(f"åŠ©æ‰‹è¯´: {agent_text}")

# 3. ç›‘å¬å®Œæ•´å¯¹è¯è½®æ¬¡
@session.on("turn_finished")
def on_turn_finished(turn):
    """
    å½“ä¸€è½®å®Œæ•´å¯¹è¯ï¼ˆç”¨æˆ·è¯´ + åŠ©æ‰‹å›å¤ï¼‰ç»“æŸæ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨
    turn å‚æ•°åŒ…å«äº†è¿™ä¸€è½®å¯¹è¯çš„å®Œæ•´ä¿¡æ¯
    """
    user_text = turn.user_speech.text    # ç”¨æˆ·è¯´çš„è¯
    agent_text = turn.agent_speech.text  # åŠ©æ‰‹è¯´çš„è¯
    print(f"å®Œæ•´å¯¹è¯: ç”¨æˆ·={user_text}, åŠ©æ‰‹={agent_text}")
```

## ğŸ”„ å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·è¯´è¯
   â†“
2. LiveKit è§¦å‘ "user_transcript" äº‹ä»¶
   â†“
3. è‡ªåŠ¨è°ƒç”¨ on_user_speaks() å‡½æ•°
   â†“
4. åŠ©æ‰‹å›å¤
   â†“
5. LiveKit è§¦å‘ "agent_transcript" äº‹ä»¶
   â†“
6. è‡ªåŠ¨è°ƒç”¨ on_agent_speaks() å‡½æ•°
   â†“
7. ä¸€è½®å¯¹è¯ç»“æŸ
   â†“
8. LiveKit è§¦å‘ "turn_finished" äº‹ä»¶
   â†“
9. è‡ªåŠ¨è°ƒç”¨ on_turn_finished() å‡½æ•°
```

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶ç›‘å¬ï¼Ÿ

### é—®é¢˜ï¼šå¦‚ä½•æ•è·å¯¹è¯å†…å®¹ï¼Ÿ

åœ¨åŸå§‹çš„ `agent.py` ä¸­ï¼Œå¯¹è¯æ­£å¸¸è¿›è¡Œï¼Œä½†æˆ‘ä»¬**æ— æ³•è·å–**ç”¨æˆ·å’ŒåŠ©æ‰‹è¯´äº†ä»€ä¹ˆã€‚

### è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨äº‹ä»¶ç›‘å¬

é€šè¿‡ç›‘å¬äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
1. **å®æ—¶æ•è·**ç”¨æˆ·å’ŒåŠ©æ‰‹çš„å¯¹è¯
2. **ä¿å­˜å¯¹è¯**åˆ° MemU è®°å¿†ç³»ç»Ÿ
3. **åˆ†æå¯¹è¯**å†…å®¹
4. **è®°å½•æ—¥å¿—**ç”¨äºè°ƒè¯•

## ğŸ“ åœ¨ agent.py ä¸­çš„å®é™…åº”ç”¨

æŸ¥çœ‹ `agent.py` æ–‡ä»¶ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```python
# åœ¨ session.start() ä¹‹å‰æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
@session.on("user_transcript")
def on_user_speaks(transcript):
    # å¤„ç†ç”¨æˆ·è¯´è¯...

@session.on("agent_transcript")
def on_agent_speaks(transcript):
    # å¤„ç†åŠ©æ‰‹å›å¤...

@session.on("turn_finished")
def on_turn_finished(turn):
    # å¤„ç†å®Œæ•´å¯¹è¯è½®æ¬¡...
```

**é‡è¦**ï¼šäº‹ä»¶ç›‘å¬å™¨å¿…é¡»åœ¨ `session.start()` **ä¹‹å‰**æ³¨å†Œï¼Œå¦åˆ™æ— æ³•æ•è·äº‹ä»¶ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **äº‹ä»¶åç§°å¿…é¡»æ­£ç¡®**ï¼š`"user_transcript"` ä¸æ˜¯ `"user_speech"`
2. **å‡½æ•°å‚æ•°**ï¼šå‡½æ•°æ¥æ”¶çš„å‚æ•°ç±»å‹å–å†³äºäº‹ä»¶ç±»å‹
3. **åŒæ­¥ vs å¼‚æ­¥**ï¼šLiveKit çš„ `.on()` æ–¹æ³•åªæ”¯æŒåŒæ­¥å‡½æ•°
4. **æ³¨å†Œæ—¶æœº**ï¼šå¿…é¡»åœ¨ `session.start()` ä¹‹å‰æ³¨å†Œ

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ ç†è§£äº†äº‹ä»¶ç›‘å¬çš„æ¦‚å¿µï¼Œå¯ä»¥ï¼š
1. è¿è¡Œ `agent.py` æŸ¥çœ‹äº‹ä»¶ç›‘å¬çš„æ—¥å¿—è¾“å‡º
2. ä¿®æ”¹äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæ·»åŠ è‡ªå·±çš„é€»è¾‘
3. å°†å¯¹è¯ä¿å­˜åˆ° MemU è®°å¿†ç³»ç»Ÿï¼ˆå‚è€ƒ `agent1.py`ï¼‰

